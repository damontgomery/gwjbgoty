<!doctype html>
<html>
<head>
  <title>Game of the year tally</title>
  <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
  <script type="text/javascript">
    'use strict';
    (function ($) {
      $(document).ready(function(){
        
        var $rawdata = $('#rawdata');
        var $results = $('.results');
        var data;

        $('.calculate').click(function(){
          // try to read the input.
          try {
            data = $.parseJSON($rawdata.val());
            var sums = {};
            var games = [];

            $.each(data, function(username, top10){
              $.each(top10, function(index, game){
                if (game === ''){
                  return;
                }

                var points = 10 - index;

                if (typeof sums[game] === 'undefined') {
                  games.push(game);
                  sums[game] = {'votes' : 0, 'points' : 0, 'top' : 0};
                }

                sums[game].votes++;
                sums[game].points += points;
                
                if (index === 0) {
                  sums[game].top++;
                }

              });
            });

            var output = {};
            // sort
            output.points = games.sort(function(a, b){
              return sums[b].points - sums[a].points;
            }).slice();

            output.top = games.sort(function(a, b){
              return sums[b].top - sums[a].top;
            }).slice();

            output.votes = games.sort(function(a, b){
              return sums[b].votes - sums[a].votes;
            }).slice();

            output.all = games.sort().slice();

            output.games = games;

            console.log(output);
            console.log(sums);

            var outputHTML = '';

            outputHTML = '<h2>By Points</h2><table><thead><tr><th>Place</th><th>Game</th><th>Points</th><th>Votes</th><th>#1 Votes</th></tr></thead><tbody>';
            
            for (var i = 0; i <= 12; i++) {
              var game = output.points[i];
              outputHTML += '<tr><td>' + (i + 1) + '</td><td>' + game + '</td><td>' + sums[game].points + '</td><td>' + sums[game].votes + '</td><td>' + sums[game].top + '</td></tr>';
            }

            outputHTML += '</tbody></table>';

            outputHTML += '<h2>By Votes</h2><table><thead><tr><th>Place</th><th>Game</th><th>Points</th><th>Votes</th><th>#1 Votes</th></tr></thead><tbody>';
            
            for (var i = 0; i <= 12; i++) {
              var game = output.votes[i];
              outputHTML += '<tr><td>' + (i + 1) + '</td><td>' + game + '</td><td>' + sums[game].points + '</td><td>' + sums[game].votes + '</td><td>' + sums[game].top + '</td></tr>';
            }

            outputHTML += '</tbody></table>';

            outputHTML += '<h2>By #1 Votes</h2><table><thead><tr><th>Place</th><th>Game</th><th>Points</th><th>Votes</th><th>#1 Votes</th></tr></thead><tbody>';
            
            for (var i = 0; i <= 12; i++) {
              var game = output.top[i];
              outputHTML += '<tr><td>' + (i + 1) + '</td><td>' + game + '</td><td>' + sums[game].points + '</td><td>' + sums[game].votes + '</td><td>' + sums[game].top + '</td></tr>';
            }

            outputHTML += '</tbody></table>';

            outputHTML += '<h2>All Games Alphabetical</h2><table><thead><tr><th>Place</th><th>Game</th><th>Points</th><th>Votes</th><th>#1 Votes</th></tr></thead><tbody>';
            
            $.each(output.all, function(i, game){
              outputHTML += '<tr><td>' + (i + 1) + '</td><td>' + game + '</td><td>' + sums[game].points + '</td><td>' + sums[game].votes + '</td><td>' + sums[game].top + '</td></tr>';
            });

            outputHTML += '</tbody></table>';

            $results.html(outputHTML);
          }
          catch(error) {
            console.log(error.message);
            $results.html('Your JSON could not be read.');
          }
        });
      });
    })(jQuery);
  </script>

  <style>
    body {
      font-family: verdana, sans-serif;
    }

    textarea {
      width: 90%;
      padding: 1em;
    }

    .results {
      padding: 1em;
      width: 90%;
      border: 1px solid black;
      min-height: 100px;
    }

    button {
      display: block;
    }

    table {
        border: 1px solid gray;
        border-collapse: collapse;
    }

    td, th {
        border: 1px solid gray;
        padding: 0.5em;
    }

  </style>
</head>
<body>
  <h1>Paste in your data here in JSON format:</h1>
  <h2>Example</h2>
  <pre><code>
{
"PandaEskimo" : ["Coup", "Liar's Dice", "Bang! The Dice Game", "Om Nom Nom", "1775: Rebellion", "Jamaica", "Sushi Go", "Shadow Hunters", "One Night Ultimate Werewolf", "Corto"],
"trichy" : ["Sheriff of Nottingham", "Sherlock Holmes: Consulting Detective", "Lifeboat", "Sekigahara", "Two Rooms and a Boom", "New Amsterdam", "Liar's Dice", "", "", ""]
}
  </code></pre> 
  <textarea name="rawdata" id="rawdata" cols="30" rows="10"></textarea>
  <button class="calculate">Calculate Results</button>
  <h2>Results</h2>
  <div class="results">
    
  </div>
</body>
</html>